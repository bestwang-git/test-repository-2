# Makefile for NETCONF project
#  
#   NCX agent main directory

############### SOURCE PROFILE ##############################

ifndef PREFIX
    PREFIX=/usr
endif

PROJECT_NM=yumapro
SUBDIR_NM=agt
SUBDIR_CPP=
LIBPREFIX=
LIBNAME=lib$(LIBPREFIX)$(PROJECT_NM)_$(SUBDIR_NM)

############### TARGET PROFILE ##############################

TARGET=$(TBASE)/$(SUBDIR_NM)
BIN_INST=$(TBASE)/bin

LIB_INST=$(TBASE)/lib

ifdef FREEBSD
 REAL_INST=$(DESTDIR)$(PREFIX)/lib
else
 ifdef LIB64
  REAL_INST=$(DESTDIR)$(PREFIX)/lib64
 else
  REAL_INST=$(DESTDIR)$(PREFIX)/lib
 endif # LIB64
endif # FREEBSD

# if the target is DEBIAN or RPM package, then
# install the include files
REAL_INC_INST=$(DESTDIR)$(PREFIX)/include/$(PROJECT_NM)

#################### MAKE RULES ########################
ifdef DEVELOPER
all:
else
all: agtdummy agtlib
endif  # DEVELOPER

#################### PLATFORM DEFINITIONS ############
include ../platform/platform.profile

################ DEPENDENCIES #########################
# depend rule must be included after the 'all' make rule

include ../platform/platform.profile.depend

BLD_INCLUDES=

ifndef DEBIAN
 ifndef EVAL
  BLD_INCLUDES=includes
 endif # EVAL
endif # DEBIAN

test:

# build the library in any developer context
# and in the 1-pass RPM RELEASE build
# for ubunte RELEASE builds, only build if 
# this is the yuma package (not DEVELOPER)

# build the library in any developer context
# and in the 1-pass RPM RELEASE build
# for ubunte RELEASE builds, only build if 
# this is real build not DEVELOPER
ifdef DEBIAN

 ifdef DEVELOPER
# just install the H files
install: includes
 endif # DEVELOPER

 ifdef SERVER
# install the AGT library and includes
install: includes install-agtlib
 endif # SERVER

 ifdef EVAL
# install the AGT library
install: install-agtlib
 endif # EVAL

 ifdef SHLIB_NCX
# do not install anything for libncx
install:
 endif # SHLIB_NCX

 ifdef CLIENT
# do not install anything for client
install:
 endif # CLIENT

 ifdef BUILD_ALL
# install everything for build all
install: includes install-agtlib
 endif # BUILD_ALL

else # not DEBIAN

 ifdef CROSS_TARGET
# don't install anything
install:
 else # not CROSS_TARGET
# Fedora package or normal build: 'make' or 'make STATIC=1'
install: $(BLD_INCLUDES) install-agtlib
 endif # CROSS_TARGET
endif # DEBIAN


install-agtlib:
# install static or dynamic libagt file
	mkdir -p $(REAL_INST)
	install -v $(OWNER) $(GRP) \
	$(LIB_INST)/$(LIBNAME).$(LIBNCXSUFFIX) $(REAL_INST)
ifndef STATIC
 ifndef FREEBSD
  ifndef PACKAGE_BUILD
   ifndef MAC
# skip in MacOsX, RPM, FreeBSD and rest of debian fakeroot builds
	ldconfig $(REAL_INST)
   endif  # MAC
  endif  # PACKAGE_BUILD
 endif  # FREEBSD
endif  # STATIC

uninstall:
	rm -f $(REAL_INST)/$(LIBNAME).$(LIBSUFFIX)*
	rm -rf $(REAL_INC_INST)/$(SUBDIR_NM)

# check which variant of the library to build
ifdef DEVELOPER
agtlib:
else
agtlib: $(LBASE)/$(LIBNAME).$(LIBNCXSUFFIX)
 ifndef STATIC
  ifndef MAC
	(cd $(LBASE); ln -f -s $(LIBNAME).$(LIBNCXSUFFIX) \
	$(LIBNAME).$(LIBSUFFIX))
  endif  # MAC
 endif  # STATIC
endif  # DEVELOPER


# this dummy rule keeps make from deleting the $(OBJS) as
# intermediate files
agtdummy: dependencies $(OBJS)

clean:
	rm -f $(OBJS) $(LBASE)/$(LIBNAME).*


superclean:
	rm -f *~  $(DEPS) dependencies $(OBJS) \
	$(LBASE)/$(LIBNAME).*

distclean: superclean


ifdef WINDOWS
 RDYNAMIC=
 LC=
else
 RDYNAMIC=-rdynamic
 LC=-lc
endif

# this rule is ignored if STATIC=1; used only in linux
$(LBASE)/$(LIBNAME).so.$(SOVERSION): $(OBJS)
ifdef FREEBSD
	$(CC) $(CFLAGS) -shared $(RDYNAMIC) -Wl,-soname,$(LIBNAME).so.$(SOVERSION) \
	-o $@ $(OBJS) -L/usr/local/lib $(LC) -lxml2
else
	$(CC) $(CFLAGS) -shared $(RDYNAMIC) -Wl,-soname,$(LIBNAME).so.$(SOVERSION) \
	-o $@ $(OBJS) $(LC) -lxml2
endif

# this rule is ignored if STATIC=1; used only on MacOSX
$(LBASE)/$(LIBNAME).dylib: $(OBJS)
	$(CC) $(CFLAGS) -shared -dynamiclib -std=gnu99 -current_version \
	$(SOVERSION) \
	-undefined dynamic_lookup \
	-o $@ -install_name $(LIBNAME).dylib $(OBJS) -lxml2


includes:
	mkdir -p $(REAL_INC_INST)/$(SUBDIR_NM)
	cp *.h $(REAL_INC_INST)/$(SUBDIR_NM)


.PHONY: includes agtlib agtdummy install-agtlib


# prevent the make program from choking on all the symbols
# that get generated from autogenerated make rules
.NOEXPORT:

include dependencies
